#!/bin/bash

# Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð´Ð»Ñ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ Ð²ÑÐµÑ… Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹ Go Ð´Ð¾ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ñ… ÑÑ‚Ð°Ð±Ð¸Ð»ÑŒÐ½Ñ‹Ñ… Ð²ÐµÑ€ÑÐ¸Ð¹
# Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ: ./update-deps.sh

set -e

# Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½ÐµÐ¹ ÑÑ‚Ð°Ð±Ð¸Ð»ÑŒÐ½Ð¾Ð¹ Ð²ÐµÑ€ÑÐ¸Ð¸ Ð¼Ð¾Ð´ÑƒÐ»Ñ
get_stable_version() {
    local module=$1
    # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ ÑÐ¿Ð¸ÑÐ¾Ðº Ð²ÑÐµÑ… Ð²ÐµÑ€ÑÐ¸Ð¹ Ð¸ Ñ„Ð¸Ð»ÑŒÑ‚Ñ€ÑƒÐµÐ¼ pre-release Ð²ÐµÑ€ÑÐ¸Ð¸
    local versions=$(go list -m -versions "$module" 2>/dev/null | awk '{for(i=2;i<=NF;i++) print $i}')

    # Ð¤Ð¸Ð»ÑŒÑ‚Ñ€ÑƒÐµÐ¼ Ð²ÐµÑ€ÑÐ¸Ð¸: Ð¸ÑÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ alpha, beta, rc, pre Ð¸ Ñ‚.Ð´.
    local stable=$(echo "$versions" | grep -v -E '(alpha|beta|rc|pre|dev|snapshot)' | tail -n 1)

    if [ -z "$stable" ]; then
        echo "latest"
    else
        echo "$stable"
    fi
}

echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ‚ÐµÐºÑƒÑ‰ÐµÐ¹ Ð²ÐµÑ€ÑÐ¸Ð¸ Go..."
go version

echo ""
echo "ðŸ“¦ ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð²ÑÐµÑ… Ð¿Ñ€ÑÐ¼Ñ‹Ñ… Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹ Ð´Ð¾ ÑÑ‚Ð°Ð±Ð¸Ð»ÑŒÐ½Ñ‹Ñ… Ð²ÐµÑ€ÑÐ¸Ð¹..."
# ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ ÑÐ¿Ð¸ÑÐ¾Ðº Ð²ÑÐµÑ… Ð¿Ñ€ÑÐ¼Ñ‹Ñ… Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹ Ð¸ Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð¸Ñ…
go list -m -f '{{if not .Indirect}}{{.Path}}{{end}}' all | grep -v "^$" | grep -v "github.com/bifshteksex/hertzboard" | while read -r module; do
    echo "  ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° $module..."
    version=$(get_stable_version "$module")
    echo "  â¬†ï¸  ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ $module@$version..."
    go get "$module@$version"
done

echo ""
echo "ðŸ”„ ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ ÐºÐ¾ÑÐ²ÐµÐ½Ð½Ñ‹Ñ… Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹ (patch-ÑƒÑ€Ð¾Ð²ÐµÐ½ÑŒ)..."
# Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ -u=patch Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¸Ð·Ð±ÐµÐ¶Ð°Ñ‚ÑŒ major/minor pre-release Ð²ÐµÑ€ÑÐ¸Ð¹
go get -u=patch ./...

echo ""
echo "ðŸ§¹ ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° Ð¸ Ð¾Ð¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ñ go.mod..."
go mod tidy

echo ""
echo "âœ… Ð’ÑÐµ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹ Ð´Ð¾ ÑÑ‚Ð°Ð±Ð¸Ð»ÑŒÐ½Ñ‹Ñ… Ð²ÐµÑ€ÑÐ¸Ð¹!"
echo ""
echo "ðŸ“‹ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ‹Ñ… Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹:"
go list -m -u all

echo ""
echo "âœ¨ Ð“Ð¾Ñ‚Ð¾Ð²Ð¾! ÐÐµ Ð·Ð°Ð±ÑƒÐ´ÑŒÑ‚Ðµ Ð¿Ñ€Ð¾Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ð¿Ð¾ÑÐ»Ðµ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ."
